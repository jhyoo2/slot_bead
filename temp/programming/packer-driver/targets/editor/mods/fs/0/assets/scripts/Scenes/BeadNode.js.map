{"version":3,"sources":["file:///Users/david/Desktop/David/cocos/slot_bead/assets/scripts/Scenes/BeadNode.ts"],"names":["_decorator","Node","Vec2","Vec3","RigidBody2D","SpriteFrame","Sprite","UIOpacityComponent","Collider2D","Contact2DType","tween","BaseScene","ccclass","property","BeadNode","onLoad","myColor","Math","floor","random","node","getComponent","spriteFrame","beadFrame","collider","on","BEGIN_CONTACT","onBeginContact","changeShape","myShape","bidRigid","myForce","sqrt","pow","linearVelocity","x","y","time","copyNode","copySprite","addComponent","setScale","shapeFrame","nodeShape","shapeNode","parent","addChild","by","position","call","removeFromParent","destroy","start","setPosition","delay","beadStart","selfCollider","otherCollider","contact","myRigid","addRandomForce","myIdx","applyForce","diminishVelocity","rate","maxVelocity","update","dt","maxForce","preVelo","angularVelocity","coverNode","opacity"],"mappings":"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","sourcesContent":["import {\r\n  _decorator,\r\n  size,\r\n  director,\r\n  Node,\r\n  PhysicsSystem2D,\r\n  Vec2,\r\n  PHYSICS_2D_PTM_RATIO,\r\n  EPhysics2DDrawFlags,\r\n  RigidBody,\r\n  Vec3,\r\n  RigidBody2D,\r\n  Prefab,\r\n  instantiate,\r\n  SpriteFrame,\r\n  Sprite,\r\n  UIOpacityComponent,\r\n  Collider2D,\r\n  Contact2DType,\r\n  IPhysics2DContact,\r\n  tween,\r\n} from \"cc\";\r\nconst { ccclass, property } = _decorator;\r\n\r\nimport BaseScene from \"../BaseObject/BaseScene\";\r\nimport AssetManager from \"../DataManager/AssetManager\";\r\nimport BaseRoom from \"../Prefabs/Room/BaseRoom\";\r\n\r\n@ccclass(\"BeadNode\")\r\nexport class BeadNode extends BaseScene {\r\n  beadStart = false;\r\n  myForce = 0;\r\n  myColor = 0;\r\n  myIdx = 0;\r\n\r\n  @property(Node)\r\n  coverNode: Node | null = null;\r\n\r\n  @property(SpriteFrame)\r\n  beadFrame: SpriteFrame[] = [];\r\n\r\n  @property(Node)\r\n  shapeNode: Node | null = null;\r\n\r\n  @property(SpriteFrame)\r\n  shapeFrame: SpriteFrame[] = [];\r\n\r\n  maxForce = 0;\r\n  nodeShape = 0;\r\n  maxVelocity = new Vec2(0, 0);\r\n\r\n  async onLoad() {\r\n    super.onLoad();\r\n    const myColor = Math.floor(Math.random() * 5) + 1;\r\n    this.node.getComponent(Sprite).spriteFrame = this.beadFrame[myColor];\r\n    let collider = this.getComponent(Collider2D);\r\n    if (collider) {\r\n      collider.on(Contact2DType.BEGIN_CONTACT, this.onBeginContact, this);\r\n    }\r\n    this.changeShape();\r\n  }\r\n\r\n  changeShape() {\r\n    let myShape = Math.floor(Math.random() * 4);\r\n    const bidRigid = this.node.getComponent(RigidBody2D);\r\n    const myForce = Math.sqrt(\r\n      Math.pow(bidRigid.linearVelocity.x, 2) +\r\n        Math.pow(bidRigid.linearVelocity.y, 2)\r\n    );\r\n    let time = 1.0;\r\n    if (myForce > 10) {\r\n      time = 0.05;\r\n    } else if (myForce > 5) {\r\n      time = 0.1;\r\n    } else if (myForce > 3) {\r\n      time = 0.3;\r\n    } else if (myForce > 1) {\r\n      time = 0.5;\r\n      myShape = 3;\r\n    } else {\r\n      myShape = 3;\r\n    }\r\n\r\n    const copyNode = new Node();\r\n    const copySprite = copyNode.addComponent(Sprite);\r\n    copyNode.setScale(new Vec3(2.5, 2.5, 2.5));\r\n    copySprite.spriteFrame = this.shapeFrame[this.nodeShape];\r\n    this.shapeNode.parent.addChild(copyNode);\r\n\r\n    this.nodeShape = myShape;\r\n    this.shapeNode.getComponent(Sprite).spriteFrame = this.shapeFrame[myShape];\r\n\r\n    tween(copyNode)\r\n      .by(time, { position: new Vec3(0, 150, 0) })\r\n      .call(() => {\r\n        copyNode.removeFromParent();\r\n        copyNode.destroy();\r\n      })\r\n      .start();\r\n\r\n    this.shapeNode.setPosition(new Vec3(0, -150, 0));\r\n\r\n    tween(this.shapeNode)\r\n      .by(time, { position: new Vec3(0, 150, 0) })\r\n      .delay(time / 2)\r\n      .call(() => {\r\n        if (!this.beadStart && this.nodeShape == 3) {\r\n          return;\r\n        }\r\n        this.changeShape();\r\n      })\r\n      .start();\r\n  }\r\n\r\n  onBeginContact(\r\n    selfCollider: Collider2D,\r\n    otherCollider: Collider2D,\r\n    contact: IPhysics2DContact | null\r\n  ) {\r\n    if (this.beadStart) {\r\n      const myColor = Math.floor(Math.random() * 3) + 1;\r\n      this.node.getComponent(Sprite).spriteFrame = this.beadFrame[myColor];\r\n    }\r\n    if (otherCollider.node.getComponent(BeadNode)) {\r\n      const myRigid = this.node.getComponent(RigidBody2D);\r\n      // myRigid.linearVelocity = new Vec2(\r\n      //   Math.max(this.maxVelocity.x, myRigid.linearVelocity.x * 2.2),\r\n      //   Math.max(this.maxVelocity.y, myRigid.linearVelocity.y * 2.2)\r\n      // );\r\n    }\r\n  }\r\n\r\n  addRandomForce() {\r\n    this.beadStart = true;\r\n    const bidRigid = this.node.getComponent(RigidBody2D);\r\n    const myForce = new Vec2(\r\n      -40000 + 80000 * Math.random(),\r\n      90000 + 30000 * Math.random() + 10000 * this.myIdx\r\n    );\r\n    bidRigid.applyForce(\r\n      myForce,\r\n      new Vec2(myForce.x / 100, myForce.y / 100),\r\n      true\r\n    );\r\n  }\r\n\r\n  diminishVelocity(rate) {\r\n    const bidRigid = this.node.getComponent(RigidBody2D);\r\n    bidRigid.linearVelocity = new Vec2(\r\n      bidRigid.linearVelocity.x * rate,\r\n      bidRigid.linearVelocity.y * rate\r\n    );\r\n    this.maxVelocity = new Vec2(\r\n      this.maxVelocity.x * rate,\r\n      this.maxVelocity.y * rate\r\n    );\r\n  }\r\n\r\n  update(dt) {\r\n    if (!this.beadStart) {\r\n      return;\r\n    }\r\n    const bidRigid = this.node.getComponent(RigidBody2D);\r\n\r\n    const myForce = Math.sqrt(\r\n      Math.pow(bidRigid.linearVelocity.x, 2) +\r\n        Math.pow(bidRigid.linearVelocity.y, 2)\r\n    );\r\n    if (this.maxForce < myForce) {\r\n      this.maxForce = myForce;\r\n      this.maxVelocity = new Vec2(\r\n        bidRigid.linearVelocity.x,\r\n        bidRigid.linearVelocity.y\r\n      );\r\n    }\r\n    this.myForce += myForce;\r\n    if (myForce > 0) {\r\n      const preVelo = bidRigid.linearVelocity;\r\n      if (myForce <= 0.1) {\r\n        bidRigid.linearVelocity = new Vec2(0, 0);\r\n        bidRigid.angularVelocity = 0;\r\n        this.coverNode.getComponent(UIOpacityComponent).opacity = 0;\r\n        this.beadStart = false;\r\n      } else if (myForce > 10) {\r\n        bidRigid.linearVelocity = new Vec2(\r\n          preVelo.x * 0.9975 + 0.001 * this.myIdx,\r\n          preVelo.y * 0.9975 + 0.001 * this.myIdx\r\n        );\r\n      } else if (myForce > 1) {\r\n        bidRigid.linearVelocity = new Vec2(\r\n          preVelo.x * 0.985 + 0.0005 * this.myIdx,\r\n          preVelo.y * 0.985 + 0.0005 * this.myIdx\r\n        );\r\n      } else {\r\n        bidRigid.linearVelocity = new Vec2(\r\n          preVelo.x * 0.95 + 0.001 * this.myIdx,\r\n          preVelo.y * 0.95 + 0.001 * this.myIdx\r\n        );\r\n      }\r\n      if (myForce <= 3) {\r\n        this.coverNode.getComponent(UIOpacityComponent).opacity =\r\n          (myForce / 3) * 255;\r\n      }\r\n    }\r\n    // console.log(myForce);\r\n  }\r\n}\r\n"]}